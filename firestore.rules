rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users can only read/write their own data.
    // Disallow listing all users to prevent unbounded queries.
    match /users/{userId} {
      allow read, update, delete: if isOwner(userId);
      allow create: if request.auth != null;

      // Friends subcollection
      match /friends/{friendId} {
        allow read: if isOwner(userId);
        // Writing to friends is handled by cloud functions
        allow write: if false;
      }

      // Progress subcollection
      match /progress/{wordId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Prevent listing all users
    match /users/{document=**} {
        allow list: if false;
    }


    // Friend requests can be created by any authenticated user.
    // They can only be read by the sender or receiver.
    // They can only be deleted by the receiver.
    match /friendRequests/{requestId} {
      allow create: if request.auth != null;
      allow read: if isOwner(resource.data.from_uid) || isOwner(resource.data.to_uid);
      allow update: if isOwner(resource.data.to_uid); // receiver can accept
      allow delete: if isOwner(resource.data.to_uid); // receiver can decline
    }
    
    // Daily stats can only be read by the user they belong to.
    // They are written by a cloud function.
    match /dailyStats/{statId} {
        allow read: if isOwner(resource.data.userId);
        allow write: if false; // Only backend can write
    }
    
    // Default deny all other reads/writes
    match /{document=**} {
      allow read, write: if false;
    }
  }
}